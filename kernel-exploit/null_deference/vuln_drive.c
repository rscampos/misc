/*
 * Simple example calling a function at address 0x0 (NULL).
 * We just map a null page in user-space and put our payload there.
 */

#include <linux/module.h>
#include <linux/kernel.h>
#include <linux/fs.h>
#include <linux/uaccess.h>
#include <linux/miscdevice.h>
#include <linux/errno.h>
#include <linux/init.h>
#include <linux/string.h>

static const char device_name[]       = "vulndrive";
void (*my_funptr)(void);

ssize_t device_write(struct file *filp,
		     const char *bufSourceData, size_t bufCount,
		     loff_t *curOffset)
{

	pr_info("&my_funptr[my_funptr] %p[%p]\n", &my_funptr, my_funptr);
	my_funptr();
	return bufCount;
}

const struct file_operations fops = {
	.write		= device_write
};

struct miscdevice miscdev = {
	.minor		= MISC_DYNAMIC_MINOR,
	.name		= device_name,
	.fops		= &fops,
	.mode		= 0777
};

static int driver_entry(void)
{
	return misc_register(&miscdev);
}

static int driver_exit(void)
{
	misc_deregister(&miscdev);
}

module_init(driver_entry);
module_exit(driver_exit);
MODULE_LICENSE("GPL");
